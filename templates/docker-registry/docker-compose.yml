name: ${NAME}

services:
  ${NAME}:
    image: registry:2
    container_name: ${NAME}
    restart: unless-stopped
    environment:
      REGISTRY_AUTH: htpasswd
      REGISTRY_AUTH_HTPASSWD_REALM: Registry Realm
      REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
    volumes:
      - ./registry-data:/var/lib/registry
      - ./auth:/auth
    networks:
      ${NETWORKS}
    labels:
      - "traefik.enable=true"
      # https router
      - "traefik.http.routers.${NAME}.entrypoints=websecure"
      - "traefik.http.routers.${NAME}.rule=Host(`${SERVICE}`)"
      - "traefik.http.routers.${NAME}.tls.certresolver=le"
      - "traefik.http.services.${NAME}.loadbalancer.server.port=5000"
      # http â†’ https redirect
      - "traefik.http.routers.${NAME}-redirect.entrypoints=web"
      - "traefik.http.routers.${NAME}-redirect.rule=Host(`${SERVICE}`)"
      - "traefik.http.routers.${NAME}-redirect.middlewares=redirect-to-https"
      # middleware definition
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

networks:
  ${NETWORK_DEFINITIONS}
